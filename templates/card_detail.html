{% extends "base.html" %}

{% block title %}{{ card[1] if card else 'Card Not Found' }} - Magic Collector{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="fas fa-cards-blank"></i> {{ card[1] if card else 'Card Not Found' }}</h1>
                {% if set_info %}
                <p class="text-muted">{{ set_info[2] }} • {{ set_info[4] or 'Unknown Release Date' }}</p>
                {% endif %}
            </div>
            <div>
                {% if set_info %}
                <a href="/cards/{{ set_info[1] }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Set
                </a>
                {% endif %}
                <a href="/sets" class="btn btn-outline-primary">
                    <i class="fas fa-layer-group"></i> All Sets
                </a>
            </div>
        </div>
    </div>
</div>

{% if card %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                
                {% if card_faces_data %}
                <!-- Double-sided card -->
                <div class="row">
                    {% for face in card_faces_data %}
                    <div class="col-12 mb-3">
                        <h6 class="mb-2">{{ face.name }}</h6>
                        {% if face.type_line %}
                        <p class="text-muted small mb-2">{{ face.type_line }}</p>
                        {% endif %}
                        {% if face.image_uris %}
                        <img src="{{ face.image_uris.large or face.image_uris.normal or '' }}" class="img-fluid" alt="{{ face.name }}" style="max-height: 400px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center" style="height: 300px; border-radius: 8px;">
                            <i class="fas fa-image fa-3x text-muted"></i>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% elif card[37] %}
                <!-- Single-sided card with image -->
                {% set image_data = card[37]|from_json %}
                <img src="{{ image_data.large or image_data.normal or '' }}" class="img-fluid" alt="{{ card[1] }}" style="max-height: 500px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                {% else %}
                <!-- No image available -->
                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 400px; border-radius: 8px;">
                    <i class="fas fa-image fa-5x text-muted"></i>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Card Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Name:</strong></div>
                    <div class="col-sm-8">{{ card[1] }}</div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Mana Cost:</strong></div>
                    <div class="col-sm-8">{{ card[2] or 'None' }}</div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Converted Mana Cost:</strong></div>
                    <div class="col-sm-8">{{ card[3] or '0' }}</div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Type:</strong></div>
                    <div class="col-sm-8">{{ card[4] or 'Unknown' }}</div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Rarity:</strong></div>
                    <div class="col-sm-8">
                        <span class="badge bg-{% if card[24] == 'mythic' %}danger{% elif card[24] == 'rare' %}warning{% elif card[24] == 'uncommon' %}info{% else %}secondary{% endif %}">
                            {{ card[24] or 'Unknown' }}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Collector Number:</strong></div>
                    <div class="col-sm-8">{{ card[23] or 'Unknown' }}</div>
                </div>
                
                {% if card[6] or card[7] %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Power/Toughness:</strong></div>
                    <div class="col-sm-8">{{ card[6] or '' }}{% if card[6] and card[7] %}/{% endif %}{{ card[7] or '' }}</div>
                </div>
                {% endif %}
                
                {% if card[25] %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Artist:</strong></div>
                    <div class="col-sm-8">{{ card[25] }}</div>
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>In Collection:</strong></div>
                    <div class="col-sm-8" id="collection-badges">
                        {% if non_foil_qty > 0 or foil_qty > 0 %}
                            {% if non_foil_qty > 0 %}
                                <span class="badge bg-primary me-1">{{ non_foil_qty }} regular</span>
                            {% endif %}
                            {% if foil_qty > 0 %}
                                <span class="badge bg-warning me-1">{{ foil_qty }} foil</span>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-secondary">0 owned</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Collection Management -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-plus-circle"></i> Add to Collection</h5>
            </div>
            <div class="card-body">
                <form id="collectionForm">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="quantity" class="form-label">Quantity to Add:</label>
                            <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" max="100">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isFoil" name="isFoil">
                                <label class="form-check-label" for="isFoil">
                                    <i class="fas fa-star text-warning"></i> Foil
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add to Collection
                            </button>
                        </div>
                    </div>
                </form>
                <div id="collectionMessage" class="mt-3"></div>
            </div>
        </div>
        
        {% if card[5] %}
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-scroll"></i> Oracle Text</h5>
            </div>
            <div class="card-body">
                <p class="card-text">{{ card[5]|replace('\n', '<br>')|safe }}</p>
            </div>
        </div>
        {% endif %}
        
        {% if card[10] %}
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-gavel"></i> Legalities</h5>
            </div>
            <div class="card-body">
                {% set legalities = card[10]|from_json %}
                {% if legalities and legalities is mapping %}
                <div class="row">
                    {% for format, status in legalities.items() %}
                    <div class="col-md-6 mb-2">
                        <span class="badge bg-{% if status == 'legal' %}success{% elif status == 'banned' %}danger{% elif status == 'restricted' %}warning{% else %}secondary{% endif %}">
                            {{ format|title }}: {{ status|title }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No legality information available</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% if card[34] %}
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-dollar-sign"></i> Pricing</h5>
            </div>
            <div class="card-body">
                {% set prices = card[34]|from_json %}
                {% if prices and prices is mapping %}
                <div class="row">
                    {% if prices.usd %}
                    <div class="col-md-6 mb-2">
                        <strong>USD:</strong> ${{ prices.usd }}
                    </div>
                    {% endif %}
                    {% if prices.usd_foil %}
                    <div class="col-md-6 mb-2">
                        <strong>USD Foil:</strong> ${{ prices.usd_foil }}
                    </div>
                    {% endif %}
                    {% if prices.eur %}
                    <div class="col-md-6 mb-2">
                        <strong>EUR:</strong> €{{ prices.eur }}
                    </div>
                    {% endif %}
                    {% if prices.tix %}
                    <div class="col-md-6 mb-2">
                        <strong>MTGO:</strong> {{ prices.tix }} tix
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-muted">No pricing information available</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Other Printings Section -->
{% if other_printings %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-copy"></i> Other Printings
                    <span class="badge bg-secondary ms-2">{{ other_printings|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">This card appears in {{ other_printings|length }} other set(s):</p>
                <div class="row">
                    {% for printing in other_printings %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 border">
                            <a href="/card/{{ printing[0] }}" class="text-decoration-none text-dark">
                                <div class="card-body p-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        {% set image_uris = printing[4]|from_json if printing[4] else {} %}
                                        {% if image_uris.normal %}
                                        <img src="{{ image_uris.normal }}" class="img-fluid" style="width: 60px; height: auto; border-radius: 4px;" alt="{{ printing[1] }}">
                                        {% else %}
                                        <div class="bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 84px; border-radius: 4px;">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="card-title mb-1">{{ printing[1] }}</h6>
                                        <p class="card-text small text-muted mb-1">
                                            <strong>{{ printing[6] }}</strong> ({{ printing[2] }})
                                        </p>
                                        <p class="card-text small mb-1">
                                            <span class="badge bg-{% if printing[5] == 'mythic' %}danger{% elif printing[5] == 'rare' %}warning{% elif printing[5] == 'uncommon' %}info{% else %}secondary{% endif %}">
                                                {{ printing[5].title() }}
                                            </span>
                                            <span class="text-muted ms-1">#{{ printing[3] }}</span>
                                        </p>
                                        <p class="card-text small text-muted mb-2">
                                            Released: {{ printing[7] or 'Unknown' }}
                                        </p>
                                        <small class="text-muted">
                                            <i class="fas fa-mouse-pointer"></i> Click to view details
                                        </small>
                                    </div>
                                </div>
                                </div>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning text-center">
            <h4><i class="fas fa-exclamation-triangle"></i> Card Not Found</h4>
            <p>The requested card could not be found in the database.</p>
            <a href="/sets" class="btn btn-primary">
                <i class="fas fa-layer-group"></i> Browse Sets
            </a>
        </div>
    </div>
</div>
{% endif %}

<script>
document.getElementById('collectionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const quantity = document.getElementById('quantity').value;
    const isFoil = document.getElementById('isFoil').checked;
    const cardId = '{{ card[0] if card else "" }}';
    const messageDiv = document.getElementById('collectionMessage');
    
    if (!cardId) {
        messageDiv.innerHTML = '<div class="alert alert-danger">Card ID not found</div>';
        return;
    }
    
    fetch('/add_to_collection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            card_id: cardId,
            quantity: parseInt(quantity),
            is_foil: isFoil
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            // Update the collection badges
            updateCollectionBadges(data.non_foil_qty, data.foil_qty);
            // Reset form
            document.getElementById('quantity').value = '1';
            document.getElementById('isFoil').checked = false;
        } else {
            messageDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
        }
    })
    .catch(error => {
        messageDiv.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
    });
});

function updateCollectionBadges(nonFoilQty, foilQty) {
    const collectionDiv = document.getElementById('collection-badges');
    if (!collectionDiv) return;
    
    let badgeHtml = '';
    if (nonFoilQty > 0 || foilQty > 0) {
        if (nonFoilQty > 0) {
            badgeHtml += '<span class="badge bg-primary me-1">' + nonFoilQty + ' regular</span>';
        }
        if (foilQty > 0) {
            badgeHtml += '<span class="badge bg-warning me-1">' + foilQty + ' foil</span>';
        }
    } else {
        badgeHtml = '<span class="badge bg-secondary">0 owned</span>';
    }
    
    collectionDiv.innerHTML = badgeHtml;
}

</script>
{% endblock %}
