{% extends "base.html" %}

{% block title %}Magic Collector - Buy/Sell Trades{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-exchange-alt"></i> Buy/Sell Trades</h1>
            <button class="btn btn-primary" onclick="addTrade()">
                <i class="fas fa-plus"></i> Add Trade
            </button>
        </div>
        
        <!-- Summary Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-primary">{{ total_trades }}</h5>
                        <p class="text-muted mb-0">Total Trades</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-success">${{ "%.2f"|format(total_bought) }}</h5>
                        <p class="text-muted mb-0">Total Bought</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-info">${{ "%.2f"|format(total_sold) }}</h5>
                        <p class="text-muted mb-0">Total Sold</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="{% if total_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ "%.2f"|format(total_profit) }}
                        </h5>
                        <p class="text-muted mb-0">Total Profit</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trades Table -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Trade History</h5>
            </div>
            <div class="card-body">
                {% if trades %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Set</th>
                                    <th>Card</th>
                                    <th>Direction</th>
                                    <th>Quantity</th>
                                    <th>Foil</th>
                                    <th>Price</th>
                                    <th>Total Amount</th>
                                    <th>Profit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in trades %}
                                <tr>
                                    <td>{{ trade[8]|strftime('%Y-%m-%d %H:%M') if trade[8] else 'N/A' }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ trade[1] }}</span>
                                        {% if trade[10] %}
                                        <br><small class="text-muted">{{ trade[10] }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if trade[11] %}
                                        {{ trade[11] }}
                                        {% else %}
                                        <span class="text-muted">Card #{{ trade[2] }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if trade[3] == 'Buy' %}success{% else %}warning{% endif %}">
                                            {{ trade[3] }}
                                        </span>
                                    </td>
                                    <td>{{ trade[4] }}</td>
                                    <td>
                                        {% if trade[9] %}
                                        <span class="badge bg-warning">Foil</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Regular</span>
                                        {% endif %}
                                    </td>
                                    <td>${{ "%.2f"|format(trade[5]) }}</td>
                                    <td>${{ "%.2f"|format(trade[6]) }}</td>
                                    <td>
                                        <span class="{% if trade[7] >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            ${{ "%.2f"|format(trade[7]) }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTrade({{ trade[0] }}, '{{ trade[1] }}', '{{ trade[2] }}', '{{ trade[3] }}', {{ trade[4] }}, {{ trade[9]|lower }})" title="Delete Trade">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if total_pages > 1 %}
                    <nav aria-label="Trade pagination">
                        <ul class="pagination justify-content-center">
                            {% if page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('view_trades', page=page-1) }}">Previous</a>
                            </li>
                            {% endif %}
                            
                            {% for p in range(1, total_pages + 1) %}
                                {% if p == page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ p }}</span>
                                </li>
                                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('view_trades', page=p) }}">{{ p }}</a>
                                </li>
                                {% elif p == 4 and page > 5 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% elif p == total_pages - 3 and page < total_pages - 4 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('view_trades', page=page+1) }}">Next</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No trades recorded yet</h5>
                        <p class="text-muted">Start tracking your buy/sell transactions by adding your first trade.</p>
                        <button class="btn btn-primary" onclick="addTrade()">
                            <i class="fas fa-plus"></i> Add Your First Trade
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Trade Modal -->
<div class="modal fade" id="addTradeModal" tabindex="-1" aria-labelledby="addTradeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTradeModalLabel">Add New Trade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTradeForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tradeDate" class="form-label">Trade Date</label>
                            <input type="date" class="form-control" id="tradeDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="setCode" class="form-label">Set</label>
                            <select class="form-select" id="setCode" required>
                                <option value="">Select a set...</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="collectorNumber" class="form-label">Collector Number</label>
                            <input type="number" class="form-control" id="collectorNumber" min="1" required>
                            <div class="form-text" id="collectorNumberHelp">Select a set first to see valid range</div>
                            <div class="valid-feedback" id="collectorNumberValid" style="display: none;">
                                Valid collector number for this set
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="direction" class="form-label">Direction</label>
                            <select class="form-select" id="direction" required>
                                <option value="">Select...</option>
                                <option value="Buy">Buy</option>
                                <option value="Sell">Sell</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" min="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="price" class="form-label">Price per Card ($)</label>
                            <input type="number" class="form-control" id="price" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="profit" class="form-label">Profit/Loss ($)</label>
                            <input type="number" class="form-control" id="profit" step="0.01">
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="isFoil">
                                <label class="form-check-label" for="isFoil">
                                    Foil Card
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTrade()">Save Trade</button>
            </div>
        </div>
    </div>
</div>

<script>
function addTrade() {
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('tradeDate').value = today;
    
    // Load sets dropdown
    loadSets();
    
    const modal = new bootstrap.Modal(document.getElementById('addTradeModal'));
    modal.show();
}

function loadSets() {
    fetch('/get_sets')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const setSelect = document.getElementById('setCode');
                setSelect.innerHTML = '<option value="">Select a set...</option>';
                
                data.sets.forEach(set => {
                    const option = document.createElement('option');
                    option.value = set.code;
                    option.textContent = `${set.name} (${set.code})`;
                    setSelect.appendChild(option);
                });
                
                // Add event listener for set changes
                setSelect.addEventListener('change', handleSetChange);
                
                // Add event listener for collector number changes
                document.getElementById('collectorNumber').addEventListener('input', validateCollectorNumber);
            } else {
                console.error('Error loading sets:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading sets:', error);
        });
}

function handleSetChange() {
    const setCode = document.getElementById('setCode').value;
    const collectorNumberInput = document.getElementById('collectorNumber');
    const collectorNumberHelp = document.getElementById('collectorNumberHelp');
    
    if (setCode) {
        // Fetch set info to get max collector number
        fetch(`/get_set_info/${setCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const maxCollector = data.set_info.max_collector_number;
                    collectorNumberInput.max = maxCollector;
                    collectorNumberInput.placeholder = `1 to ${maxCollector}`;
                    collectorNumberHelp.textContent = `Valid range: 1 to ${maxCollector}`;
                    collectorNumberHelp.className = 'form-text text-success';
                } else {
                    collectorNumberHelp.textContent = 'Error loading set info';
                    collectorNumberHelp.className = 'form-text text-danger';
                }
            })
            .catch(error => {
                collectorNumberHelp.textContent = 'Error loading set info';
                collectorNumberHelp.className = 'form-text text-danger';
            });
    } else {
        collectorNumberInput.max = '';
        collectorNumberInput.placeholder = '';
        collectorNumberHelp.textContent = 'Select a set first to see valid range';
        collectorNumberHelp.className = 'form-text';
    }
}

function validateCollectorNumber() {
    const collectorNumberInput = document.getElementById('collectorNumber');
    const collectorNumberValid = document.getElementById('collectorNumberValid');
    const collectorNumberHelp = document.getElementById('collectorNumberHelp');
    
    const value = parseInt(collectorNumberInput.value);
    const maxValue = parseInt(collectorNumberInput.max);
    
    if (value && maxValue && value >= 1 && value <= maxValue) {
        collectorNumberInput.classList.remove('is-invalid');
        collectorNumberInput.classList.add('is-valid');
        collectorNumberValid.style.display = 'block';
        collectorNumberHelp.style.display = 'none';
    } else if (value && maxValue && (value < 1 || value > maxValue)) {
        collectorNumberInput.classList.remove('is-valid');
        collectorNumberInput.classList.add('is-invalid');
        collectorNumberValid.style.display = 'none';
        collectorNumberHelp.style.display = 'block';
        collectorNumberHelp.textContent = `Invalid number. Valid range: 1 to ${maxValue}`;
        collectorNumberHelp.className = 'form-text text-danger';
    } else {
        collectorNumberInput.classList.remove('is-valid', 'is-invalid');
        collectorNumberValid.style.display = 'none';
        collectorNumberHelp.style.display = 'block';
    }
}

function saveTrade() {
    const tradeDate = document.getElementById('tradeDate').value;
    const setCode = document.getElementById('setCode').value;
    const collectorNumber = parseInt(document.getElementById('collectorNumber').value);
    const direction = document.getElementById('direction').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const price = parseFloat(document.getElementById('price').value);
    const profit = parseFloat(document.getElementById('profit').value) || 0;
    const isFoil = document.getElementById('isFoil').checked;
    
    // Validate trade date is not in the future
    const today = new Date().toISOString().split('T')[0];
    if (tradeDate > today) {
        alert('Trade date cannot be in the future');
        return;
    }
    
    // Validate collector number
    const maxCollector = parseInt(document.getElementById('collectorNumber').max);
    if (collectorNumber < 1 || collectorNumber > maxCollector) {
        alert(`Collector number must be between 1 and ${maxCollector} for this set`);
        return;
    }
    
    const totalAmount = quantity * price;
    
    // Send trade data to server
    fetch('/add_trade', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            trade_date: tradeDate,
            set_code: setCode,
            collector_number: collectorNumber,
            direction: direction,
            quantity: quantity,
            price: price,
            profit: profit,
            is_foil: isFoil
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTradeModal'));
            modal.hide();
            // Reset form
            document.getElementById('addTradeForm').reset();
            // Reload page to show new trade
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving trade: ' + error.message);
    });
}

// Auto-calculate total amount when price or quantity changes
document.getElementById('price').addEventListener('input', calculateTotal);
document.getElementById('quantity').addEventListener('input', calculateTotal);

function calculateTotal() {
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const price = parseFloat(document.getElementById('price').value) || 0;
    const totalAmount = quantity * price;
    
    // You could display this somewhere in the UI
    console.log('Total amount:', totalAmount);
}

function deleteTrade(tradeId, setCode, collectorNumber, direction, quantity, isFoil) {
    const foilText = isFoil ? 'foil' : 'regular';
    const message = `Are you sure you want to delete this ${direction.toLowerCase()} trade?\n\n` +
                   `Set: ${setCode}\n` +
                   `Card: #${collectorNumber}\n` +
                   `Quantity: ${quantity} ${foilText}\n\n` +
                   `This will also ${direction === 'Buy' ? 'remove' : 'add back'} ${quantity} ${foilText} cards from your collection.`;
    
    if (confirm(message)) {
        fetch('/delete_trade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                trade_id: tradeId,
                set_code: setCode,
                collector_number: collectorNumber,
                direction: direction,
                quantity: quantity,
                is_foil: isFoil
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Reload page to show updated data
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting trade: ' + error.message);
        });
    }
}
</script>
{% endblock %}
